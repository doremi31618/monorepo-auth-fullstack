name: CI

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  actions: read
  contents: read

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Setup Node.js
      - uses: actions/setup-node@v4
        id: setup-node
        with:
          node-version: 20
          cache: npm

      # Cache node_modules for faster installs
      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ steps.setup-node.outputs.node-version }}-node_modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ steps.setup-node.outputs.node-version }}-node_modules-

      - name: Show Node/npm versions
        run: |
          node --version
          npm --version
          npm config get registry
          mkdir -p ci-metrics
          free -h | tee ci-metrics/memory.txt
          df -h | tee ci-metrics/disk.txt

      - name: Upload runner diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: runner-diagnostics
          path: ci-metrics

      # Install Dependencies
      - name: Install Dependencies
        timeout-minutes: 20
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        env:
          NPM_CONFIG_FETCH_RETRIES: 5
          NPM_CONFIG_FETCH_RETRY_MINTIMEOUT: 20000
          NPM_CONFIG_FETCH_RETRY_MAXTIMEOUT: 120000
          NPM_CONFIG_FETCH_TIMEOUT: 120000
          NPM_CONFIG_LEGACY_PEER_DEPS: true
          NPM_CONFIG_LOGLEVEL: warn
          NPM_CONFIG_NETWORK_TIMEOUT: 120000
          NPM_CONFIG_OPTIONAL: false
          NPM_CONFIG_PROGRESS: false
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
        run: |
          set -euo pipefail
          for attempt in 1 2; do
            echo "npm ci attempt ${attempt}"
            if npm ci --prefer-offline --no-audit --no-fund --timing; then
              exit 0
            fi
            echo "npm ci failed, cleaning cache and retrying..."
            npm cache clean --force
          done
          exit 1

      # Run affected lint, test, build
      - run: npx nx affected -t lint --parallel=3

      # Run affected test
      - run: npx nx affected -t test --parallel=3 --configuration=ci

      # Run affected build
      - run: npx nx affected -t build --parallel=3
